#textdomain wesnoth-Shadows_of_Deception

#wmllint: local spellings Hehehe hehe dem de Ssssss

[scenario]
    id=06_Awakening_part_1
    name= _ "Awakening — Part 1"
    {MAP 06_Awakening_part_1.map}
    turns=-1
    next_scenario=07_Frozen_Tears
    victory_when_enemies_defeated=no

    {DUNGEON}

    # Rest of playlist set in starting cutscene
    {SCENARIO_MUSIC wanderer.ogg}

    {STORYTXT_AWAKENING_PART_I}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        save_id=Rhyan
        {GOLD 50 40 30}
        team_name=good
        user_team_name= _ "team_name^Rhyan"
        {RAGGED_FLAG}

        {NO_INCOME}

        # wmllint: recognize Rhyan
        {CHARACTER_STATS:RHYAN_AS_LEADER}
        variation=hatless

        hitpoints=23
        facing=sw
        shroud=yes

        [unit]
            # wmllint: recognize Ella
            {CHARACTER_STATS:ELLA}

            x,y=45,35
            hitpoints=28
            facing=ne
        [/unit]
    [/side]
    # wmllint: validate-on

    [side]
        side=2
        controller=ai
        recruit=Skeleton, Skeleton Archer, Ghoul, Dark Adept
        {GOLD 170 180 190}
        team_name=guards
        user_team_name= _ "team_name^Guards"
        {UNDEAD_FLAG}

        type=Deathblade
        name= _ "Revekel"
        id=Revekel
        canrecruit=yes
        unrenamable=yes
        ai_special=guardian

        hidden=yes
        facing=se

        {GENERIC_UNIT () (Skeleton)        41 27} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Skeleton Archer) 43 28} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Bone Shooter) 26 23} {GUARDIAN} {FACING ne}
        {GENERIC_UNIT () (Bone Shooter) 29 21} {GUARDIAN} {FACING sw}

        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "fighter,fighter,archer"}
            {AI_SIMPLE_ALWAYS_ASPECT grouping            no}
            {AI_SIMPLE_ALWAYS_ASPECT aggression          1.0}
        [/ai]
    [/side]

    [side]
        side=3
        controller=ai
        recruit=Saurian Augur, Saurian Skirmisher, Orcish Grunt, Orcish Archer
        {GOLD 150 175 200}
        team_name=guards
        user_team_name= _ "team_name^Guards"
        {RAGGED_FLAG}

        type=Saurian Flanker
        name= _ "Yerar"
        id=Yerar
        canrecruit=yes
        unrenamable=yes
        ai_special=guardian

        facing=nw
        hidden=yes
        color=brown

        # wmllint: recognize Bar
        {NAMED_LOYAL_UNIT () (Ogre) 52 23 (Bar) ( _ "Bar")} {GUARDIAN} {FACING ne}

        {GENERIC_UNIT () "Northguard Archer" 53 18} {GUARDIAN} {FACING nw}

        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "archer,archer,fighter,scout"}
            {AI_SIMPLE_ALWAYS_ASPECT grouping            defensive}
            {AI_SIMPLE_ALWAYS_ASPECT caution             0.10}
            {AI_SIMPLE_ALWAYS_ASPECT aggression          1.0}
        [/ai]
    [/side]

    [side]
        side=4
        controller=ai
        recruit=Northguard Archer, Troll Whelp
        {GOLD 190 210 230}
        team_name=guards
        user_team_name= _ "team_name^Guards"
        {NORTHGUARD_FLAG}

        type=Northguard Warrior
        name= _ "Sylla"
        id=Sylla
        gender=female

        facing=ne
        hidden=yes
        color=black

        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT grouping offensive}
        [/ai]

        {GENERIC_UNIT () "Troll Warrior" 21 22} {GUARDIAN} {FACING ne}
    [/side]

    [side]
        side=5
        controller=ai
        no_leader=yes
        team_name=guards,creatures
        user_team_name= _ "team_name^Creatures"
        hidden=yes
        color=brown

        {GENERIC_UNIT () (Giant Scorpion) 50 14} {GUARDIAN} {FACING nw}
        {GENERIC_UNIT () (Giant Rat)        9 6} {GUARDIAN} {FACING sw}
    [/side]

    # Gate controller side
    [side]
        side=6
        controller=null
        no_leader=yes
        team_name=guards
        user_team_name= _ "team_name^Guards"
        hidden=yes
        color=black
    [/side]

    {DUNGEON_NOISE_3_SOUND_SOURCE}
    [+sound_source]
        id=api_dungeon_ambiance
    [/sound_source]

    # Scenery images
    {PLACE_IMAGE scenery/bookshelf-sw.png 36 33}
    {PLACE_IMAGE scenery/bookshelf-sw.png 37 34}
    {PLACE_IMAGE scenery/bookshelf-sw.png 57 27}
    {PLACE_IMAGE scenery/bookshelf-sw.png 58 27}
    {PLACE_IMAGE scenery/bookshelf.png 55 21}

    {PLACE_IMAGE scenery/bookshelf-full.png 7 7}
    {PLACE_IMAGE scenery/bookshelf-full.png 39 31}
    {PLACE_IMAGE scenery/bookshelf-full.png 52 26}
    {PLACE_IMAGE scenery/bookshelf-full.png 8 6}

    {PLACE_IMAGE scenery/blood1.png 47 34}
    {PLACE_IMAGE scenery/blood2.png 9 10}
    {PLACE_IMAGE scenery/monolith3.png 56 22}
    {PLACE_IMAGE scenery/rock-cairn.png 24 36}
    {PLACE_IMAGE "scenery/rock-cairn.png~FL(horiz)" 26 36}

    {PLACE_IMAGE scenery/rune2.png 10 39}
    {PLACE_IMAGE scenery/rune4.png 10 39}

    {PLACE_IMAGE items/bones.png 11 32}
    {PLACE_IMAGE "items/bones.png~FL(horiz)" 25 15}

    {PLACE_IMAGE items/bonestack.png 37 30}
    {PLACE_IMAGE items/bonestack.png 13 8}

    {PLACE_IMAGE items/book1.png 6 12}
    {PLACE_IMAGE items/chest.png 48 3}
    {PLACE_IMAGE items/box.png 58 20}
    {PLACE_IMAGE items/box.png 59 21}
    {PLACE_IMAGE items/box.png 64 30}
    {PLACE_IMAGE items/stone-tablet.png 52 28}

    {PLACE_IMAGE {ITEM_DUMMY_IMAGE brown} 62 30}
    {PLACE_IMAGE {ITEM_DUMMY_IMAGE brown} 50 35}
    {PLACE_IMAGE items/barrel.png 16 20}
    {PLACE_IMAGE items/barrel.png 17 21}

    # Treasure vault items
    {PLACE_IMAGE scenery/signpost.png 25 30}

    {PLACE_IMAGE items/box.png 8 35}
    {PLACE_IMAGE items/box.png 36 42}
    {PLACE_IMAGE items/box.png 37 44}
    {PLACE_IMAGE items/box.png 35 46}
    {PLACE_IMAGE items/box.png 32 45}
    {PLACE_IMAGE items/box.png 7 35}
    {PLACE_IMAGE items/chest-plain-closed.png 4 34}
    {PLACE_IMAGE items/chest-plain-closed.png 5 34}
    {PLACE_IMAGE items/chest-plain-closed.png 6 33}
    {PLACE_IMAGE items/chest.png 35 44}
    {PLACE_IMAGE {ITEM_DUMMY_IMAGE brown} 33 44}
    {PLACE_IMAGE {ITEM_DUMMY_IMAGE brown} 3 36}
    {PLACE_IMAGE items/ball-blue.png 34 44}
    {PLACE_IMAGE items/staff.png 4 36}

    # Statues. Yup. Totally
    {PLACE_IMAGE "units/undead-skeletal/banebow.png~GS()" 21 34}
    {PLACE_IMAGE "units/undead-skeletal/draug.png~GS()~FL(horiz)" 29 34}

    # Need to use a manual [item] here because it needs a halo= key
    [item]
        x,y=38,32
        image=items/altar-evil.png
        halo=scenery/circle-magic-glow.png
    [/item]

    {ITEM_TOUCHPLATE 25 34}

    {CHEST_WITH_GOLD 16 27 31}
    {CHEST_WITH_GOLD 36 32 20}
    {CHEST_WITH_GOLD 6  7  27}

    {FORCE_CHANCE_TO_HIT (side=2) (side=1) 30 (
        {VARIABLE_BOOLEAN_NOT_EQUALS guards_have_fled yes}
    )}

#define API_IS_CHARACTER
    id=Rhyan,Ella
#enddef

#define API_GALAMOR_FILTER
    [have_unit]
        side=1
        id=Galamor # wmllint: ignore
    [/have_unit]
#enddef

    # Force CTH from elementals on the gate Galamor is behind
    # This is to prevent the event being triggered by an elemental
    # since it would look weird to have one speak
    {FORCE_CHANCE_TO_HIT (
        side=1
        [not]
            {API_IS_CHARACTER}
        [/not]
    ) (x,y=33,39) 0 (
    )}

    [event]
        name=prestart

        {INIT_CAMPAIGN_MENUS}

        {INIT_INITIAL_ITEMS_B}

        {VARIABLE guards_have_fled no}

        {VARIABLE vault_west_trigger_on no}
        {VARIABLE vault_east_trigger_on no}

        {VARIABLE vault_west_wall_moved no}
        {VARIABLE vault_east_wall_moved no}

        [setup_gates]
            side=6
        [/setup_gates]

        [hide_unit][/hide_unit]

        {BLACK_SCREEN}
    [/event]

#define A_RHYAN_THOUGHT _MESSAGE
    [message]
        speaker=narrator
        caption= _ "Rhyan"
        image= # wmllint: ignore
        message="<i>"+{_MESSAGE}+"</i>" # wmllint: ignore
    [/message]
#enddef

    [event]
        name=start

        {LOCK_VIEW}

        [place_shroud]
            side=1
            {EVERYWHERE}
        [/place_shroud]

        [delay]
            time=1500
        [/delay]

        {A_RHYAN_THOUGHT ( _ "My head hurt. A lot.")}

        [delay]
            time=750
        [/delay]

        {A_RHYAN_THOUGHT ( _ "The last I remember was watching the gentle play of sunlight through the trees outside camp, before someone — or something — crept behind and knocked me out cold.")}

        [delay]
            time=750
        [/delay]

        {A_RHYAN_THOUGHT ( _ "Swirling images assailed the back of my eyelids as I struggled to find some sort of mental purchase in the mists of unconsciousness.

How long had I been out?")}

        [delay]
            time=1500
        [/delay]

        {A_RHYAN_THOUGHT ( _ "And then...")}

        [delay]
            time=1500
        [/delay]

        [redraw]
            side=1
        [/redraw]

        {FADE_IN_SLOW}

        [unhide_unit][/unhide_unit]

        [delay]
            time=1500
        [/delay]

        [message]
            speaker=Ella
            message= _ "Ah, there you are. I was starting to wonder whether you got knocked over the head just a <i>little</i> too hard."
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Rhyan
            message= _ "(<i>groan</i>) Well, sorry to disappoint you... whoever you are. Where are we?"
        [/message]

        [message]
            speaker=Ella
            message= _ "You got chucked in here a few hours ago. At least, I think it’s been hours. Could be days. Or longer? Bottom line, you’ve been out a while."
        [/message]

        [delay]
            time=1500
        [/delay]

        [message]
            speaker=Rhyan
            message= _ "How... how did I get here?"
        [/message]

        [message]
            speaker=Ella
            message= _ "(<i>eyebrows raised</i>) You’re asking me?"
        [/message]

        [message]
            speaker=Rhyan
            message= _ "Well... ugghh..."
        [/message]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Ella
            message= _ "I’m not going to lie, you really look like death."
        [/message]

        [message]
            speaker=narrator
            image=misc/blank-hex.png
            message= _ "The rogue took a dusty vial from a pouch by her side, and approached."
        [/message]

        {MOVE_UNIT id=Ella 47 34}

        [message]
            speaker=Ella
            message= _ "Here, take this. I saved it, but you look like you could use it more."
        [/message]

        [fire_event]
            name=epp
            [primary_unit]
                id=Rhyan
            [/primary_unit]
        [/fire_event]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=misc/blank-hex.png
            message= _ "For a moment, Rhyan swayed, then fell to the floor in a faint."
        [/message]

        [delay]
            time=500
        [/delay]

        [hide_unit][/hide_unit]

        {FADE_TO_BLACK}

        [place_shroud]
            side=1
            {EVERYWHERE}
        [/place_shroud]

        [fade_out_music][/fade_out_music]

        [store_unit]
            [filter]
                id=Ella
            [/filter]
            variable=temp_ella_jump_store
            kill=yes
        [/store_unit]

        {VARIABLE temp_ella_jump_store.facing ne}
        {VARIABLE temp_ella_jump_store.hidden yes}

        [unstore_unit]
            variable=temp_ella_jump_store
            x,y=46,36
        [/unstore_unit]

        # This is necessary since .hidden is not serialized
        # and therefor does nothing. Remove once that's fixed
        [hide_unit][/hide_unit]

        {CLEAR_VARIABLE temp_ella_jump_store}

        [interim_text]
            text= _ "Time passes..."
        [/interim_text]

        [clear_print][/clear_print]

        [redraw]
            side=1
        [/redraw]

        {FADE_IN}

        {REPLACE_SCENARIO_MUSIC "the_city_falls.ogg"}
        {APPEND_MUSIC           "into_the_shadows.ogg"}
        {APPEND_MUSIC           "underground.ogg"}
        {APPEND_MUSIC           "heroes_rite.ogg"}
        {APPEND_MUSIC           "weight_of_revenge.ogg"}

        [unhide_unit][/unhide_unit]

        [message]
            speaker=narrator
            image=misc/blank-hex.png
            message= _ "Rhyan groaned and stood up, looking over at the girl now standing in the corner of the dark cell."
        [/message]

        [message]
            speaker=Rhyan
            message= _ "Thanks for that; I own you one..."
        [/message]

        [message]
            speaker=Ella
            message= _ "Ella."
        [/message]

        [message]
            speaker=Rhyan
            message= _ "You know, you do look slightly familiar... Have we met? Granted, it would be a strange coincidence if that were true."
        [/message]

        [message]
            speaker=Ella
            message= _ "Considering you’ve still failed to mention your name, where you’re from, or even what you were doing before being bludgeoned, I wouldn’t know. And even if we had, I don’t recognize you at all."
        [/message]

        [message]
            speaker=Rhyan
            message= _ "The name’s Rhyan —"
        [/message]

        [sound]
            name=gate.ogg
        [/sound]

        [kill]
            x=44,45
            y=31,31
            fire_event=yes
        [/kill]

        [move_unit_fake]
            type=Skeleton
            side=2
            x=42,48
            y=29,32
        [/move_unit_fake]

        [unit]
            type=Skeleton
            id=guard1
            name= _ "Guard"
            side=2
            x,y=48,32
            facing=se
            role=initial_guard
        [/unit]

        [move_unit_fake]
            type=Revenant
            side=2
            x=40,45
            y=29,32
        [/move_unit_fake]

        [unit]
            type=Revenant
            id=guard2
            name= _ "Guard"
            side=2
            x,y=45,32
            facing=se
            role=initial_guard
        [/unit]

        [message]
            speaker=guard1
            message= _ "Come with us, both of you!"
        [/message]

        [message]
            speaker=guard2
            message= _ "(<i>cackle cackle</i>)"
        [/message]

        [scroll_to_unit]
            id=Ella
        [/scroll_to_unit]

        # TODO: visual flair?

        [unit]
            side=1
            type=Fire Wisp
            x,y=46,35
            random_gender=yes
            random_traits=yes
            generate_name=yes
            animate=yes
            upkeep=free
            {IS_LOYAL}
            facing=ne
            [modifications]
                {TRAIT_LOYAL}
                [object]
                    silent=yes
                    [effect]
                        apply_to=hitpoints
                        heal_full=yes
                        increase_total={DIFF 25 20 15}
                    [/effect]
                    [effect]
                        apply_to=attack
                        range=melee
                        increase_damage=2
                    [/effect]
                    [effect]
                        apply_to=attack
                        range=ranged
                        increase_damage=2
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [delay]
            time=500
        [/delay]

        {FACE_UNIT id=Rhyan id=Ella}

        [message]
            speaker=Rhyan
            message= _ "What on Irdya is that thing!"
        [/message]

        [message]
            speaker=Ella
            message= _ "I’ll explain later. Can we focus on the more pressing matter right now?"
        [/message]

        [message]
            speaker=Rhyan
            message= _ "Right, right."
        [/message]

        [scroll_to_unit]
            id=Rhyan
        [/scroll_to_unit]

        {FACE_DIRECTION id=Rhyan nw}

        {UNLOCK_VIEW}

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Overpower the guards")}

            {OBJECTIVE_DEFEAT ( _ "Death of Rhyan")}
            {OBJECTIVE_DEFEAT ( _ "Death of Ella")}

            {OBJECTIVE_CARRYOVER_NO_BONUS 100}
        )}
    [/event]

    # LE HAT
    {TALK_ABOUT_HAT (
        [message]
            speaker=Ella
            message= _ "(<i>eyebrow raised</i>) Nice hat."
        [/message]

        [message]
            speaker=Rhyan
            message= _ "Why, thank you. Little squashed, but it’s none the worse for wear. Or being sat on."
        [/message]
    )}

    # Keep this in its own event in order to bypass the
    # lack of delayed variable substitution where this is set
    [event]
        name=enable_elemental_summoning

        {ENABLE_ELEMENTAL_SUMMONING}
    [/event]

    # Make second starting guard run after one is defeated
    [event]
        name=die
        [filter]
            role=initial_guard
        [/filter]

        [store_unit]
            [filter]
                role=initial_guard
                [not]
                    id=$unit.id
                [/not]
            [/filter]
            variable=remaining_guard
        [/store_unit]

        [message]
            speaker=$remaining_guard.id
            message= _ "This will require reinforcements!"
        [/message]

        {MOVE_UNIT (id=$remaining_guard.id) 39 29}

        {PLACE_IMAGE items/ankh-necklace.png 45 32}

        [kill]
            role=initial_guard
        [/kill]

        {VARIABLE guards_have_fled yes}

        [delay]
            time=200
        [/delay]

        [message]
            speaker=Ella
            message= _ "Seems he dropped something."
        [/message]

        [move_unit]
            id=Ella
            to_x=45
            to_y=32
        [/move_unit]

        [fire_event]
            name=rnp
            [primary_unit]
                id=Ella
            [/primary_unit]
        [/fire_event]

        [message]
            speaker=Rhyan
            message= _ "Now to find a way out of here. I don’t suppose these boneheads left the back door conveniently open."
        [/message]

        {CLEAR_VARIABLE remaining_guard}

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Explore")}

            {OBJECTIVE_DEFEAT ( _ "Death of Rhyan")}
            {OBJECTIVE_DEFEAT ( _ "Death of Ella")}
            {OBJECTIVE_DEFEAT ( _ "Death of Galamor")} {OBJECTIVE_SHOW_IF (
                {API_GALAMOR_FILTER}
            )}

            {OBJECTIVE_CARRYOVER_NO_BONUS 100}

            {OBJECTIVE_NOTES ( _ "There may be other prisoners")}
            {OBJECTIVE_NOTES ( _ "Elementals will not be able to explore as thoroughly as Rhyan and Ella")}
        )}

        # Next turn, have some dialog on the elemental summoning
        [event]
            name="side 1 turn $($turn_number+1)"
            delayed_variable_substitution=no

            [message]
                speaker=Rhyan
                message= _ "Perhaps now you could tell me how you summoned that pile of walking rocks from thin air?"
            [/message]

            [message]
                speaker=Ella
                message= _ "It’s not a big deal. Just something I can do. And it’s not from thin air. I found if you really focus on something simple, like the earth, you can just... see how bits of it fit together and... bam! Won’t deny they come quite in handy in my, ah, line of work."
            [/message]

            [delay]
                time=1000
            [/delay]

            [message]
                speaker=Rhyan
                message= _ "Honestly, you don’t look one bit magically adept. No offense. I just wouldn’t have pegged you as a mage at first sight."
            [/message]

            [message]
                speaker=Ella
                message= _ "(<i>smiling</i>) None taken. I’m a girl of many talents, after all."
            [/message]

            [message]
                speaker=Rhyan
                message= _ "Hopefully those talents include finding ways out of dungeons. I’m freezing."
            [/message]

            [transient_message]
                message= _ "You can now summon Elementals on any vacant hex around Ella. However, you cannot control more than six at a time."
            [/transient_message]

            [fire_event]
                name=enable_elemental_summoning
            [/fire_event]
        [/event]
    [/event]

    [event]
        name="side 1 turn 10 end"

        [message]
            speaker=Ella
            message= _ "So tell me, what were you doing before you got thrown in here?"
        [/message]

        [message]
            speaker=Rhyan
            message= _ "Mostly just traveling around to various places. I was with this girl, Elynia, and her mentor. Why?"
        [/message]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Ella
            message= _ "And?"
        [/message]

        [message]
            speaker=Rhyan
            message= _ "And what? Why don’t you tell me what you were doing?"
        [/message]

        [message]
            speaker=Ella
            message= _ "My only guess is that I tried to, ah, repossess something that someone wasn’t keen to have repossessed. And then I ended up here."
        [/message]

        [message]
            speaker=Rhyan
            message= _ "(<i>eyebrow raised</i>) To the point."
        [/message]

        [message]
            speaker=Ella
            message= _ "I pride myself on it. Now, my turn to ask a question. How does the son of a noble find himself an exciting life of journeying instead of, oh, I don’t know, a job guarding some boring village?"
        [/message]

        [message]
            speaker=Rhyan
            message= _ "It’s a <i>very</i> long story, and not one I’d prefer to go into. Anyhow, I thought you didn’t know me."
        [/message]

        [message]
            speaker=Ella
            message= _ "Relax. It’s pretty obvious you’re not of my ilk. You dress way too well."
        [/message]

        [message]
            speaker=Rhyan
            message= _ "Please, like you never “repossessed” any equatable garb in your time."
        [/message]

        [message]
            speaker=Ella
            message= _ "(<i>grinning</i>) Touché, touché."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            {API_IS_CHARACTER}
            x=26-30
            y=21-24
        [/filter]

        {SCROLL_TO_LOCATION_AND_RETURN_TO_PRIMARY_UNIT (
            {HIGHLIGHT_GOAL (
                x=25,26,27
                y=22,21,21
            )}
        )}

        [if]
            {VARIABLE_BOOLEAN_EQUALS has_inner_gate_key no}
            [then]
                [message]
                    speaker=unit
                    message= _ "Locked. We’ll need to find the key."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=unit
                    message= _ "Let’s see if this key fits."
                [/message]
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=32-35
            y=16-19
        [/filter]

        [message]
            speaker=unit
            message= _ "Looks like the exit is this way, but it’s certainly locked up tight. Maybe we can find the keys around here somewhere."
        [/message]

        [allow_undo][/allow_undo]
    [/event]

    #
    # BOSS 1: Yerar
    #

    [event]
        name=sighted
        first_time_only=yes
        [filter]
            id=Yerar
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [message]
            speaker=Yerar
            message= _ "Where do you think you’re going, little human?"
        [/message]

        [message]
            speaker=Bar
            message= _ "Hehehe boss ah we gonna bash dem into de floor?"
        [/message]

        [message]
            speaker=Yerar
            message= _ "Ssssilence, Bar, there will be no bashing! They are ueslessss bashed."
        [/message]

        [message]
            speaker=second_unit
            message= _ "Since you’re being so helpful, perhaps you care to tell us what we’re doing locked away in this dungeon?"
        [/message]

        [message]
            speaker=Yerar
            message= _ "None of your businesssss! Now, take them and return them to their cells! And make sure they can’t escape this time. It would reflect badly on us if we let prissssoners walk out the front door."
        [/message]

        [message]
            speaker=Bar
            # po: 'ogre' is supposed to be a play on words of 'over'
            message= _ "Hehehe... this gonna be fun! It’s ogre now!"
        [/message]
    [/event]

    #
    # BOSS 2: Revekel
    #

    # Acts so tough now...
    [event]
        name=attack
        [filter_second]
            id=Revekel
        [/filter_second]

        [message]
            speaker=second_unit
            message= _ "What’s the point in attacking me? I am already dead. I cannot die again, but unfortunately for you, <i>you</i> can."
        [/message]
    [/event]

    # ...but not now :P
    [event]
        name=last_breath
        [filter]
            id=Revekel
        [/filter]

        [message]
            speaker=unit
            message= _ "No! You cannot escape! I will not allow it!"
        [/message]
    [/event]

    [event]
        name=sighted
        [filter]
            type=Giant Rat
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [redraw][/redraw]

        [message]
            speaker=second_unit
            message= _ "Oh great, giant rats. Just what we need on top of everything else. I hope they don’t —"
        [/message]

        [sound]
            name=hiss-die.wav
        [/sound]

        [message]
            speaker=second_unit
            message= _ "— bite..."
        [/message]
    [/event]

    #
    # BOSS 3: Sylla
    #

    [event]
        name=die
        [filter]
            # There's only one in this scenario
            type=Troll Warrior
        [/filter]

        [remove_terrain_overlays]
            terrain=*^Xo
            [filter_adjacent_location]
                x,y=21,22
            [/filter_adjacent_location]
        [/remove_terrain_overlays]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Sylla
        [/filter]

        [message]
            speaker=unit
            message= _ "Aaaaagghhhh... Slain by prisoners... What a way to go."
        [/message]
    [/event]

    #
    # Vaults
    #

#define API_SILENT_GUARDIAN _TYPE _X _Y
    [unit]
        side=4
        type={_TYPE}
        x,y={_X},{_Y}
        id=Guardian_{_TYPE}
        role=silent_guardian
        ai_special=guardian
        random_traits=no
        upkeep=free
        animate=no
        [modifications]
            {TRAIT_RESILIENT}
        [/modifications]
    [/unit]
#enddef

#define API_VAULT_MARKER_TRIGGER_EVENT _X _Y _VAR_STEM
    [event]
        name=moveto
        [filter]
            side=1
            x,y={_X},{_Y}
        [/filter]

        [item]
            x,y={_X},{_Y}
            image=misc/blank-hex.png
            halo=scenery/circle-magic-glow.png
        [/item]

        {VARIABLE "vault_{_VAR_STEM}_trigger_on" yes}
    [/event]
#enddef

    [event]
        name=moveto
        [filter]
            side=1
            x,y=25,30
        [/filter]

        [message]
            speaker=narrator
            image=scenery/signpost.png
            message= _ "Treasure Vaults."
        [/message]

        [message]
            speaker=unit
            message= _ "Ooo, definitely something good down here."
        [/message]
    [/event]

    [event]
        name=DEBUG1

        [teleport]
            [filter]
                id=Rhyan
            [/filter]
            x,y=24,29
        [/teleport]

        [teleport]
            [filter]
                id=Ella
            [/filter]
            x,y=23,29
        [/teleport]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=20-30
            y=32-37
        [/filter]

        [delay]
            time=500
        [/delay]

        [sound]
            name=magic-dark.ogg
        [/sound]

        {API_SILENT_GUARDIAN "Banebow" 21 34} {FACING se}
        {API_SILENT_GUARDIAN "Draug"   29 34} {FACING sw}

        {REMOVE_IMAGE 21 34}
        {REMOVE_IMAGE 29 34}

        [message]
            # wmllint: recognize Guardian_Banebow
            speaker=Guardian_Banebow
            message= _ "Speak the word of passage."
        [/message]

        [delay]
            time=2000
        [/delay]

        [message]
            speaker=unit
            message= _ "Crap."
        [/message]

        [message]
            # wmllint: recognize Guardian_Draug
            speaker=Guardian_Draug
            message= _ "That is not the word of passage. Die!"
        [/message]
    [/event]

    {API_VAULT_MARKER_TRIGGER_EVENT 24 36 "west"}
    {API_VAULT_MARKER_TRIGGER_EVENT 26 36 "east"}

#undef API_VAULT_MARKER_TRIGGER_EVENT
#undef API_SILENT_GUARDIAN

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            {API_IS_CHARACTER}
            x,y=25,34
        [/filter]

        [if]
            {VARIABLE_BOOLEAN_EQUALS vault_west_trigger_on no}
            {VARIABLE_BOOLEAN_EQUALS vault_east_trigger_on no}
            [then]
                [message]
                    speaker=narrator
                    image=misc/blank-hex.png
                    message= _ "Nothing happens."
                [/message]
            [/then]
        [/if]

        # West wall trigger
        [if]
            {VARIABLE_BOOLEAN_EQUALS vault_west_trigger_on yes}
            {VARIABLE_BOOLEAN_EQUALS vault_west_wall_moved no}
            [then]
                {VARIABLE target_wall.x           21}
                {VARIABLE target_wall.direction west}

                [fire_event]
                    name=vault_wall_moves
                [/fire_event]
            [/then]
        [/if]

        # East wall trigger
        [if]
            {VARIABLE_BOOLEAN_EQUALS vault_east_trigger_on yes}
            {VARIABLE_BOOLEAN_EQUALS vault_east_wall_moved no}
            [then]
                {VARIABLE target_wall.x           29}
                {VARIABLE target_wall.direction east}

                [fire_event]
                    name=vault_wall_moves
                [/fire_event]

                [message]
                    speaker=unit
                    message= _ "Now what could be hiding behind here, I wonder?"
                [/message]
            [/then]
        [/if]

        # Both walls have been triggered, cleanup
        [if]
            {VARIABLE_BOOLEAN_EQUALS vault_west_wall_moved yes}
            {VARIABLE_BOOLEAN_EQUALS vault_east_wall_moved yes}
            [then]
                [remove_item]
                    x,y=$x1,$y1
                [/remove_item]
            [/then]
        [/if]
    [/event]

    [event]
        name=vault_wall_moves
        first_time_only=no

        # y is always 37
        [scroll_to]
            x=$target_wall.x
            y=37
        [/scroll_to]

        [delay]
            time=750
        [/delay]

        {QUAKE cave-in.ogg}

        [terrain]
            x=$target_wall.x
            y=37
            terrain=Urb
        [/terrain]

        [redraw]
            side=1
        [/redraw]

        [message]
            speaker=narrator
            image=misc/blank-hex.png
            message= _ "A wall slides away."
        [/message]

        {VARIABLE vault_$target_wall.direction|_wall_moved yes}

        {CLEAR_VARIABLE target_wall}
    [/event]

    #
    # Left tunnel
    #

    [event]
        name=moveto
        [filter]
            side=1
            {API_IS_CHARACTER}
            x,y=10,39
        [/filter]

        [sound]
            name=fire.wav
        [/sound]

        {PLACE_IMAGE "scenery/rune4-glow.png" $x1 $y1}

        [terrain]
            x=8 ,11
            y=40,38
            terrain=^Bzl
            layer=overlay
        [/terrain]

        # Silently open secret passages
        [terrain]
            x=3 ,23
            y=40,46
            terrain=^Uov
            layer=overlay
        [/terrain]

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=unit
            message= _ "I wonder what that did."
        [/message]
    [/event]

    #
    # Right tunnel
    #

    [event]
        name=attack
        [filter]
            side=1
            [not]
                {API_IS_CHARACTER}
            [/not]
        [/filter]
        [filter_second]
            x,y=33,39
            type=Gate
        [/filter_second]

        [message]
            speaker=Ella
            message= _ "Seems the elementals cannot knock that gate over. Strange."
        [/message]
    [/event]

    # Galamor is discovered
    [event]
        name=die
        [filter]
            x,y=33,39
        [/filter]
        [filter_second]
            {API_IS_CHARACTER}
        [/filter_second]

        [fire_event]
            name=discover_galamor
            [primary_unit]
                id=$second_unit.id
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=discover_galamor

        [unit]
            side=1
            x,y=35,38
            hitpoints=40
            facing=sw

            # wmllint: recognize Galamor
            {CHARACTER_STATS:GALAMOR}
        [/unit]

        [redraw]
            side=1
        [/redraw]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Galamor
            message= _ "And who are ye? Some other fiend here to torture me? Well yer not gonna do it, ye’ hear?"
        [/message]

        [message]
            speaker=unit
            message= _ "We’re not here to torture you. We’re trying to find a way out of this forsaken dungeon."
        [/message]

        [message]
            speaker=Galamor
            message= _ "Oh. Eh, in that case, mind if I join ye’? This cell is so damp there be mushrooms growing."
        [/message]

        [message]
            speaker=unit
            message= _ "I don’t see why not."
        [/message]

        [show_objectives][/show_objectives]
    [/event]

    #
    # Secret room
    #

    [event]
        name=moveto
        [filter]
            side=1
            {API_IS_CHARACTER}
            x,y=12,47
        [/filter]

        # TODO
    [/event]

    #
    # Various scenario items
    #

    [event]
        id=ella_potion_pickup
        name=epp

        [take_item]
            id=Ella_potion # wmllint: ignore
            name= _ "Arcane Salve"
            image=icons/potion_red_small.png
            # wmllint: local spelling draught
            description= _ "This draught will partially heal the drinker, as well as imbibing their weapons with arcane energy until the end of the current scenario."
            effect_type="single"
            must_take=yes
            [command]
                [sound]
                    name=potion.ogg
                [/sound]

                [object]
                    id=gpotion
                    silent=yes
                    duration=scenario
                    [effect]
                        apply_to=hitpoints
                        increase=10
                    [/effect]
                    [effect]
                        apply_to=attack
                        set_type=arcane
                    [/effect]
                [/object]
            [/command]
        [/take_item]
    [/event]

    [event]
        id=regen_amulet_pickup
        name=moveto,rnp
        first_time_only=no
        [filter]
            side=1
            x,y=45,32
        [/filter]
        [filter_condition]
            {VARIABLE_BOOLEAN_EQUALS guards_have_fled yes}
        [/filter_condition]

        [take_item]
            id=regen_amulet # wmllint: ignore
            name= _ "Amulet of Regeneration"
            image=icons/ankh_necklace.png
            description= _ "This amulet will allow its wearer to heal 8 HP per turn."
            effect_type="equip"
            [command]
                [object]
                    silent=yes
                    duration=forever
                    removal_id=regen_necklace_s6
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                [/object]
            [/command]
            [removal_command]
                [object]
                    silent=yes
                    duration=forever
                    no_write=yes
                    removal_id=regen_necklace_s6
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                [/object]

                [remove_object]
                    [filter_wml]
                        removal_id=regen_necklace_s6
                    [/filter_wml]
                    skip_effects=yes
                [/remove_object]
            [/removal_command]
        [/take_item]
    [/event]

    [event]
        id=valthur_journal_v2_pickup
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=6,12
        [/filter]

        [take_item]
            id=valthur_journal_v2 # wmllint: ignore
            name= _ "Tattered Journal Vol. 2"
            image=items/book1.png
            description= _ "Another old journal. It seems to be part of a set."
            effect_type="message"
            [command]
                [transient_message]
                    speaker=narrator
                    caption= _ "Journal of Arch Mage Valthur, 612 YW"
                    image=items/book1.png
                    message= _ "<i>Last week, I spoke to Namara on the matter of these dreams that have plagued me in recent months. He could sadly offer no assistance. Not that I expected any. Thankfully they plague my sleep less, but when they do...

I used to see a forest in flames. Now I once again see the bleak expanse of sand, stretching to the horizon with no end in sight. The ruins of fallen glories once again surround me. There, beneath a towering pillar of stone, stands a woman. The sun reflects off her blazing red hair, cloak billowing in a non-existent wind.

Then I stop and stare as the sky seems to warp and bend, the heavens imploding into visions of a massive tree, stretching so high it seems to consume the entire sky. The figure before me turns her head, and I see the glint of metal, as if some monstrosity had fused flesh and steel. This time, a burst of cold light fills my vision as I awaken shaking, but thankfully safe in my tower.

One of these days I should see if Jerahl has any more of that soothing potato stew.</i>

The rest of the journal is rotted with age and unreadable."
                [/transient_message]
            [/command]
        [/take_item]
    [/event]

    # TODO: BIG SECRET THING!
    [event]
        name=moveto
        [filter]
            side=1
            x,y=48,3
        [/filter]
    [/event]

    #
    # Gate keys. Each event is spawned when a boss dies
    #

    # Places key image when the first two bosses die
    [event]
        name=die
        first_time_only=no
        [filter]
            id=Yerar,Revekel
        [/filter]

        {PLACE_IMAGE items/key.png $x1 $y1}

        [sound]
            name=tink.wav
        [/sound]

        [message]
            speaker=narrator
            image=misc/blank-hex.png
            message= _ "A small golden key tumbles to the floor."
        [/message]
    [/event]

    # Special event for Sylla's key
    [event]
        name=die
        [filter]
            id=Sylla
        [/filter]

        {PLACE_IMAGE items/rusty-key.png $x1 $y1}

        [message]
            speaker=narrator
            image=misc/blank-hex.png
            message= _ "A rust-encased key tumbles to the floor."
        [/message]

        [message]
            speaker=second_unit
            message= _ "That thing is too rusty to unlock anything. I hope there’s a spare somewhere."
        [/message]

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Find a spare key")}

            {OBJECTIVE_DEFEAT ( _ "Death of Rhyan")}
            {OBJECTIVE_DEFEAT ( _ "Death of Ella")}
            {OBJECTIVE_DEFEAT ( _ "Death of Galamor")} {OBJECTIVE_SHOW_IF (
                {API_GALAMOR_FILTER}
            )}

            {OBJECTIVE_CARRYOVER_NO_BONUS 100}

            {OBJECTIVE_NOTES ( _ "There may be other prisoners")}
            {OBJECTIVE_NOTES ( _ "Elementals will not be able to explore as thoroughly as Rhyan and Ella")}
        )}
    [/event]

    # Key for inner gate set
    [event]
        name=die
        [filter]
            id=Yerar
        [/filter]

        [event]
            id=A_key_pickup
            name=moveto
            first_time_only=no
            [filter]
                side=1
                x,y=$x1,$y1
            [/filter]

            [take_item]
                id=A_key # wmllint: ignore
                name= _ "Inner Gate Key"
                image=icons/key_silver.png
                description= _ "A large important-looking key. An inscription on the side reads “Inner Gate”."
                effect_type="single"

                {STANDARD_KEY_EFFECT 26 21}
            [/take_item]
        [/event]

        {ACTIONS_WHEN_PICKED_UP_ITEM A_key (
            {VARIABLE has_inner_gate_key yes}
        )}
    [/event]

    # Key for inner exit gate set
    [event]
        name=die
        [filter]
            id=Revekel
        [/filter]

        [event]
            id=B_key_pickup
            name=moveto
            first_time_only=no
            [filter]
                side=1
                x,y=$x1,$y1
            [/filter]

            [take_item]
                id=B_key # wmllint: ignore
                name= _ "Exit Key A"
                image=icons/key_silver.png
                description= _ "A battered metal key. It appears to be one of a set."
                effect_type="single"

                {STANDARD_KEY_EFFECT 35 16}
            [/take_item]
        [/event]

        {ACTIONS_WHEN_PICKED_UP_ITEM B_key (
            [message]
                speaker=unit
                message= _ "Perhaps this one goes to the exit."
            [/message]
        )}
    [/event]

    # Key for outer exit gate set
    # This one does NOT drop at death location, but is found in the Vault
    [event]
        name=die
        [filter]
            id=Sylla
        [/filter]

        # wmllint: deathcheck off

        [event]
            id=C_key_pickup
            name=moveto
            first_time_only=no
            [filter]
                side=1
                x,y=35,44
            [/filter]

            [sound]
                name=open-chest.wav
            [/sound]

            [message]
                speaker=unit
                message= _ "This looks like it might fit."
            [/message]

            [take_item]
                id=C_key # wmllint: ignore
                name= _ "Exit Key B"
                image=icons/key_silver.png
                description= _ "A battered metal key. It appears to be one of a set."
                effect_type="single"

                {STANDARD_KEY_EFFECT 37 15}
                [+command]
                    {ENDLEVEL_CONTINUE}
                [/command]
            [/take_item]
        [/event]

        {ACTIONS_WHEN_PICKED_UP_ITEM C_key (
            {OBJECTIVES (
                {OBJECTIVE_VICTORY ( _ "Escape")}

                {OBJECTIVE_DEFEAT ( _ "Death of Rhyan")}
                {OBJECTIVE_DEFEAT ( _ "Death of Ella")}
                {OBJECTIVE_DEFEAT ( _ "Death of Galamor")} {OBJECTIVE_SHOW_IF (
                    {API_GALAMOR_FILTER}
                )}

                {OBJECTIVE_CARRYOVER_NO_BONUS 100}

                {OBJECTIVE_NOTES ( _ "There may be other prisoners")}
                {OBJECTIVE_NOTES ( _ "Elementals will not be able to explore as thoroughly as Rhyan and Ella")}
            )}
        )}

        # wmllint: deathcheck on
    [/event]

    # Victory event
    [event]
        name=victory

        [check_for_character]
            [character]
                {CHARACTER_STATS:GALAMOR}
            [/character]
        [/check_for_character]

        [message]
            speaker=Rhyan
            message= _ "Let’s get out of here!"
        [/message]

        {CLEAR_VARIABLE guards_have_fled,has_inner_gate_key}
        {CLEAR_VARIABLE vault_east_trigger_on,vault_east_wall_moved,vault_west_trigger_on,vault_west_wall_moved}
    [/event]

    {C_HERO_DEATHS}

    {ENEMY_FAKE_DEATH_CONTROLLER}
[/scenario]

#undef A_RHYAN_THOUGHT
#undef API_GALAMOR_FILTER
#undef API_IS_CHARACTER
